{% extends "base.html" %}

{% block title %}Budget Analysis Results{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üìä Analysis Results</h1>
        <p>{{ filename }} ‚Ä¢ Analyzed on {{ timestamp }}</p>
    </div>

    <!-- Key Statistics -->
    <div class="stats-grid fade-in">
        <div class="stat-card">
            <span class="stat-icon">üí∞</span>
            <div class="stat-value">{{ "${:,.2f}".format(analysis.total_budget) }}</div>
            <div class="stat-label">Total Budget</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üìã</span>
            <div class="stat-value">{{ analysis.total_items }}</div>
            <div class="stat-label">Line Items</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">‚ö†Ô∏è</span>
            <div class="stat-value">{{ analysis.high_cost_count }}</div>
            <div class="stat-label">High-Cost Items</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üìä</span>
            <div class="stat-value">{{ "${:,.2f}".format(analysis.average_item) }}</div>
            <div class="stat-label">Average Per Item</div>
        </div>
    </div>

    <!-- Data Visualizations -->
    <div class="charts-section fade-in">
        <h2 style="margin-bottom: 20px; color: #2d3436;">üìä Visual Analysis</h2>

        <div class="charts-grid">
            <!-- Department Budget Allocation Chart -->
            <div class="chart-container">
                <h3 class="chart-title">
                    <span>üè¢</span> Department Budget Allocation
                </h3>
                <div class="chart-canvas-wrapper">
                    <canvas id="deptDoughnutChart"></canvas>
                </div>
            </div>

            <!-- Category Breakdown Chart -->
            <div class="chart-container">
                <h3 class="chart-title">
                    <span>üìÇ</span> Category Breakdown
                </h3>
                <div class="chart-canvas-wrapper">
                    <canvas id="categoryBarChart"></canvas>
                </div>
            </div>

            <!-- Budget Health Gauge -->
            {% if analysis.health_score is defined %}
            <div class="chart-container gauge">
                <h3 class="chart-title">
                    <span>üíö</span> Budget Health Score
                </h3>
                <div class="chart-canvas-wrapper">
                    <canvas id="healthGaugeChart"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- Top Expenses Chart -->
            {% if analysis.high_cost_items and analysis.high_cost_items|length > 0 %}
            <div class="chart-container">
                <h3 class="chart-title">
                    <span>‚ö†Ô∏è</span> Top 10 Highest Expenses
                </h3>
                <div class="chart-canvas-wrapper">
                    <canvas id="topExpensesChart"></canvas>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Department Breakdown -->
    {% if analysis.departments %}
    <div class="card fade-in">
        <h2 style="margin-bottom: 20px; color: #2d3436;">üè¢ Department Breakdown</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Total Amount</th>
                    <th>Percentage</th>
                    <th>Items</th>
                </tr>
            </thead>
            <tbody>
                {% for dept, stats in analysis.departments.items() %}
                <tr>
                    <td><strong>{{ dept }}</strong></td>
                    <td>{{ "${:,.2f}".format(stats.total) }}</td>
                    <td>{{ "{:.1f}%".format(stats.percentage) }}</td>
                    <td>{{ stats['items'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Category Breakdown -->
    {% if analysis.categories %}
    <div class="card fade-in">
        <h2 style="margin-bottom: 20px; color: #2d3436;">üìÇ Category Breakdown</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Total Amount</th>
                    <th>Percentage</th>
                    <th>Items</th>
                </tr>
            </thead>
            <tbody>
                {% for cat, stats in analysis.categories.items() %}
                <tr>
                    <td><strong>{{ cat }}</strong></td>
                    <td>{{ "${:,.2f}".format(stats.total) }}</td>
                    <td>{{ "{:.1f}%".format(stats.percentage) }}</td>
                    <td>{{ stats['items'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- High Cost Items -->
    {% if analysis.high_cost_items %}
    <div class="card fade-in">
        <h2 style="margin-bottom: 20px; color: #2d3436;">‚ö†Ô∏è High-Cost Items (Over 10% of Budget)</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Department</th>
                    <th>Category</th>
                </tr>
            </thead>
            <tbody>
                {% for item in analysis.high_cost_items %}
                <tr>
                    <td>{{ item.get('Description', 'N/A') }}</td>
                    <td>{{ "${:,.2f}".format(item.get('Amount', 0)) }}</td>
                    <td>{{ item.get('Department', 'N/A') }}</td>
                    <td>{{ item.get('Category', 'N/A') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- AI-Powered Recommendations -->
    <div class="card fade-in">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h2 style="margin: 0; color: #2d3436;">üí° AI-Powered Recommendations</h2>
            {% if analysis.health_score is defined %}
            <div class="health-score-badge">
                <div class="score-value">{{ analysis.health_score }}</div>
                <div class="score-label">Health Score</div>
            </div>
            {% endif %}
        </div>

        {% if analysis.recommendations and analysis.recommendations|length > 0 %}
            {% for rec in analysis.recommendations %}
            <div class="recommendation-card priority-{{ rec.priority }}">
                <div class="rec-header">
                    <span class="priority-badge priority-{{ rec.priority }}">
                        Priority {{ rec.priority }}
                    </span>
                    <span class="rec-type">{{ rec.type|upper }}</span>
                </div>

                <h3 style="margin: 10px 0; color: #2d3436; font-size: 18px;">{{ rec.title }}</h3>

                <div class="rec-insight">
                    <strong>üìä Insight:</strong> {{ rec.insight }}
                </div>

                <p class="rec-description">{{ rec.description }}</p>

                <div class="rec-action">
                    <strong>‚úì Recommended Action:</strong> {{ rec.action }}
                </div>

                {% if rec.estimated_savings %}
                <div class="savings-estimate">
                    üí∞ Potential Savings: <strong>${{ "{:,.2f}".format(rec.estimated_savings) }}</strong>
                </div>
                {% endif %}

                {% if rec.affected_items and rec.affected_items|length > 0 %}
                <details class="affected-items">
                    <summary>View {{ rec.affected_items|length }} Affected Item{{ 's' if rec.affected_items|length > 1 else '' }}</summary>
                    <table class="mini-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Department</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for item in rec.affected_items[:5] %}
                            <tr>
                                <td>{{ item.Description }}</td>
                                <td>{{ item.get('Department', 'N/A') }}</td>
                                <td>${{ "{:,.2f}".format(item.Amount) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% if rec.affected_items|length > 5 %}
                    <p style="margin-top: 10px; font-style: italic; color: #636e72;"><em>...and {{ rec.affected_items|length - 5 }} more item{{ 's' if (rec.affected_items|length - 5) > 1 else '' }}</em></p>
                    {% endif %}
                </details>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div style="padding: 30px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                <h3 style="color: #28a745; margin-bottom: 10px;">Excellent Budget Health!</h3>
                <p style="color: #636e72;">No specific recommendations at this time. Your budget appears well-balanced and efficiently allocated.</p>
            </div>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
        <a href="/" class="btn">üè† Analyze Another Budget</a>
        <a href="/sample-csv" class="btn btn-secondary">üì• Download Sample CSV</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart colors from template
    const chartColors = {{ chart_colors | tojson | safe }};

    // ========================================================================
    // 1. DEPARTMENT DOUGHNUT CHART
    // ========================================================================
    const deptCanvas = document.getElementById('deptDoughnutChart');
    if (deptCanvas) {
        const deptLabels = {{ analysis.departments.keys() | list | tojson | safe }};
        const deptData = [
            {% for dept, stats in analysis.departments.items() %}
                {{ stats.total }}{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        new Chart(deptCanvas, {
            type: 'doughnut',
            data: {
                labels: deptLabels,
                datasets: [{
                    data: deptData,
                    backgroundColor: chartColors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // ========================================================================
    // 2. CATEGORY BAR CHART
    // ========================================================================
    const catCanvas = document.getElementById('categoryBarChart');
    if (catCanvas) {
        const catLabels = {{ analysis.categories.keys() | list | tojson | safe }};
        const catData = [
            {% for cat, stats in analysis.categories.items() %}
                {{ stats.total }}{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Sort by amount (descending)
        const catSorted = catLabels.map((label, i) => ({label, value: catData[i]}))
            .sort((a, b) => b.value - a.value);

        new Chart(catCanvas, {
            type: 'bar',
            data: {
                labels: catSorted.map(item => item.label),
                datasets: [{
                    label: 'Budget Amount',
                    data: catSorted.map(item => item.value),
                    backgroundColor: chartColors[0],
                    borderColor: chartColors[0],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$' + context.parsed.x.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // ========================================================================
    // 3. HEALTH GAUGE CHART (Semicircle)
    // ========================================================================
    {% if analysis.health_score is defined %}
    const healthCanvas = document.getElementById('healthGaugeChart');
    if (healthCanvas) {
        const healthScore = {{ analysis.health_score }};

        // Gauge color based on score
        let gaugeColor = '#e74c3c'; // Red
        if (healthScore >= 80) gaugeColor = '#2ecc71'; // Green
        else if (healthScore >= 60) gaugeColor = '#f39c12'; // Orange

        // Center text plugin
        const centerTextPlugin = {
            id: 'centerText',
            afterDatasetDraw(chart) {
                const { ctx, chartArea: { width, height } } = chart;
                ctx.save();
                ctx.font = 'bold 48px sans-serif';
                ctx.fillStyle = gaugeColor;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(healthScore, width / 2, height / 2 + 20);
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#636e72';
                ctx.fillText('Health Score', width / 2, height / 2 + 50);
                ctx.restore();
            }
        };

        new Chart(healthCanvas, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [healthScore, 100 - healthScore],
                    backgroundColor: [gaugeColor, '#ecf0f1'],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [centerTextPlugin]
        });
    }
    {% endif %}

    // ========================================================================
    // 4. TOP EXPENSES CHART
    // ========================================================================
    {% if analysis.high_cost_items and analysis.high_cost_items|length > 0 %}
    const topCanvas = document.getElementById('topExpensesChart');
    if (topCanvas) {
        const topItems = [
            {% for item in analysis.high_cost_items[:10] %}
                {
                    description: "{{ item.get('Description', 'N/A')[:30] }}",
                    amount: {{ item.get('Amount', 0) }}
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Sort and get top 10
        const sortedItems = topItems.sort((a, b) => b.amount - a.amount).slice(0, 10);

        new Chart(topCanvas, {
            type: 'bar',
            data: {
                labels: sortedItems.map(item => item.description),
                datasets: [{
                    label: 'Amount',
                    data: sortedItems.map(item => item.amount),
                    backgroundColor: 'rgba(231, 76, 60, 0.8)',
                    borderColor: 'rgba(231, 76, 60, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        ticks: {
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}
